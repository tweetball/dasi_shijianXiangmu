<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è®¢å• - è¥¿æ¹–æ—…æ¸¸</title>
    <link rel="stylesheet" href="/css/order-center.css">
</head>
<body>
    <div class="order-center-container">
        <div class="page-header">
            <h1>æˆ‘çš„è®¢å•</h1>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div class="filters">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterByStatus(null, this)">å…¨éƒ¨</button>
                <button class="filter-tab" onclick="filterByStatus(0, this)">å¾…æ”¯ä»˜</button>
                <button class="filter-tab" onclick="filterByStatus(1, this)">å·²æ”¯ä»˜</button>
                <button class="filter-tab" onclick="filterByStatus(2, this)">å·²å–æ¶ˆ</button>
            </div>
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterByType(null, this)">æ‰€æœ‰ç±»å‹</button>
                <button class="filter-tab" onclick="filterByType('FOOD', this)">ç¾é£Ÿå¤–å–</button>
                <button class="filter-tab" onclick="filterByType('HOTEL', this)">é…’åº—é¢„è®¢</button>
                <button class="filter-tab" onclick="filterByType('SHOPPING', this)">è´­ç‰©å•†åŸ</button>
                <button class="filter-tab" onclick="filterByType('TRAVEL', this)">æ™¯ç‚¹æ—…æ¸¸</button>
                <button class="filter-tab" onclick="filterByType('PAYMENT', this)">ç”Ÿæ´»ç¼´è´¹</button>
            </div>
        </div>

        <!-- è®¢å•åˆ—è¡¨ -->
        <div class="order-list">
            <div id="orderListContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“¦</div>
                    <div class="empty-state-text">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStatus = null;
        let currentType = null;

        // é¡µé¢åŠ è½½æ—¶è·å–è®¢å•åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
        });

        // æŒ‰çŠ¶æ€ç­›é€‰
        function filterByStatus(status, element) {
            // æ›´æ–°çŠ¶æ€æ ‡ç­¾
            document.querySelectorAll('.filter-tabs')[0].querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');

            currentStatus = status;
            loadOrders();
        }

        // æŒ‰ç±»å‹ç­›é€‰
        function filterByType(type, element) {
            // æ›´æ–°ç±»å‹æ ‡ç­¾
            document.querySelectorAll('.filter-tabs')[1].querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');

            currentType = type;
            loadOrders();
        }

        // åŠ è½½è®¢å•åˆ—è¡¨
        function loadOrders() {
            let url = '/unified/order/list?';
            if (currentType) url += 'orderType=' + currentType + '&';
            if (currentStatus !== null) url += 'paymentStatus=' + currentStatus;

            fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('orderListContainer');
                
                if (data.success && data.list && data.list.length > 0) {
                    container.innerHTML = data.list.map(order => renderOrderCard(order)).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <div class="empty-state-text">æš‚æ— è®¢å•</div>
                            <div class="empty-state-desc">å¿«å»ä¸‹å•å§~</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                const container = document.getElementById('orderListContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-text">åŠ è½½å¤±è´¥</div>
                        <div class="empty-state-desc">è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                    </div>
                `;
            });
        }

        // æ¸²æŸ“è®¢å•å¡ç‰‡
        function renderOrderCard(order) {
            const statusClass = order.paymentStatus === 0 ? 'unpaid' : (order.paymentStatus === 1 ? 'paid' : 'cancelled');
            const statusText = order.paymentStatusText;
            const typeText = getTypeText(order.orderType);
            const createTime = new Date(order.createTime).toLocaleString('zh-CN');

            let actions = '';
            if (order.paymentStatus === 0) {
                actions = `
                    <button class="btn btn-primary" onclick="continuePayment('${order.orderNo}')">ç»§ç»­æ”¯ä»˜</button>
                    <button class="btn btn-danger" onclick="cancelOrder('${order.orderNo}')">å–æ¶ˆè®¢å•</button>
                `;
            } else if (order.paymentStatus === 2) {
                actions = `
                    <button class="btn btn-outline" onclick="deleteOrder('${order.orderNo}')">åˆ é™¤è®¢å•</button>
                `;
            } else {
                actions = `
                    <button class="btn btn-outline" onclick="viewDetail('${order.orderNo}')">æŸ¥çœ‹è¯¦æƒ…</button>
                `;
            }

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">è®¢å•å·: ${order.orderNo}</div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="order-body">
                        <div class="order-type">${typeText}</div>
                        <div class="order-title">${order.orderTitle}</div>
                        <div class="order-amount">Â¥${order.totalAmount}</div>
                    </div>
                    <div class="order-footer">
                        <div class="order-time">${createTime}</div>
                        <div class="order-actions">
                            ${actions}
                        </div>
                    </div>
                </div>
            `;
        }

        // è·å–ç±»å‹æ–‡æœ¬
        function getTypeText(type) {
            const typeMap = {
                'FOOD': 'ç¾é£Ÿå¤–å–',
                'HOTEL': 'é…’åº—é¢„è®¢',
                'SHOPPING': 'è´­ç‰©å•†åŸ',
                'TRAVEL': 'æ™¯ç‚¹æ—…æ¸¸',
                'PAYMENT': 'ç”Ÿæ´»ç¼´è´¹'
            };
            return typeMap[type] || 'æœªçŸ¥ç±»å‹';
        }

        // ç»§ç»­æ”¯ä»˜
        function continuePayment(orderNo) {
            window.location.href = '/unified/payment/checkout?orderNo=' + orderNo;
        }

        // å–æ¶ˆè®¢å•
        function cancelOrder(orderNo) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—?')) return;

            fetch('/unified/order/cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderNo: orderNo })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è®¢å•å·²å–æ¶ˆ');
                    loadOrders();
                } else {
                    alert('å–æ¶ˆå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('å–æ¶ˆè®¢å•å¤±è´¥:', error);
                alert('å–æ¶ˆå¤±è´¥,è¯·é‡è¯•');
            });
        }

        // åˆ é™¤è®¢å•
        function deleteOrder(orderNo) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—?')) return;

            fetch('/unified/order/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderNo: orderNo })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è®¢å•å·²åˆ é™¤');
                    loadOrders();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤è®¢å•å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥,è¯·é‡è¯•');
            });
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetail(orderNo) {
            alert('è®¢å•è¯¦æƒ…åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...\nè®¢å•å·: ' + orderNo);
        }
    </script>
</body>
</html>

